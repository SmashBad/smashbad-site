<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SMASH — Shadow</title>

  <!-- Polices et styles globaux (déjà utilisés sur l'accueil) -->
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* ——— Mise en page locale Shadow ——— */
    .shell{padding:32px 5%;max-width:1100px;margin:0 auto}
    .card{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:22px 22px 28px;
    }
    .title{font-family:'Audiowide',Outfit,sans-serif;font-size:28px;margin:0 0 6px}
    .muted{color:var(--muted)}
    .row{display:grid;gap:18px;margin-top:18px}

    /* Sliders */
    .slider-wrap{margin-top:8px}
    input[type="range"].slider{
      -webkit-appearance:none;appearance:none;width:100%;height:6px;border-radius:6px;
      background:rgba(255,255,255,.15);outline:none;
    }
    input[type="range"].slider::-webkit-slider-thumb{
      -webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;
      background:var(--turquoise);border:2px solid rgba(0,0,0,.25);cursor:pointer;
    }
    .ticks{display:flex;justify-content:space-between;font-size:12px;color:#8fa1b8;margin-top:6px}

    /* Grille directions */
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .dir-btn{
      height:86px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.02);color:#cfe7ff;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      cursor:pointer;transition:background .15s ease,border-color .15s ease,transform .05s ease;
      text-align:center;
    }
    .dir-btn .arrow{font-size:28px;line-height:1}
    .dir-btn .lbl{font-size:12px;opacity:.9;margin-top:6px}
    .dir-btn:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.22)}
    .dir-btn.active{background:var(--turquoise);color:#061225;border-color:transparent;font-weight:800}
    .warn{font-size:13px;color:#f8a39b;margin-top:6px;display:none}

    /* Options + GO */
    .opt{display:flex;align-items:center;gap:8px}
    .go-btn{
      width:100%;height:52px;border-radius:14px;font-weight:800;
      background:#ff5959;color:#fff;border:none;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;margin-top:12px;
      transition:filter .15s ease;
    }
    .go-btn[disabled]{opacity:.45;cursor:not-allowed}
    .go-btn:hover:not([disabled]){filter:brightness(1.05)}

    /* Exercice */
    .topbar{display:flex;align-items:center;justify-content:flex-end;margin-bottom:20px;gap:14px}
    .stop-btn{
      border:1px solid #ff4646;color:#ff4646;background:transparent;
      border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer;
    }
    .time{ text-align:right }
    .time .big{font-size:32px;font-weight:800}
    .time .small{font-size:13px;color:#8fa1b8}

    .arena{
      min-height:60vh;display:flex;align-items:center;justify-content:center;text-align:center;
    }
    .mega{
      font-family:'Outfit',system-ui;font-weight:900;
      /* flèche ENCORE plus grande */
      font-size:min(34vw, 20rem);
      line-height:1;color:var(--turquoise);
      text-shadow:0 8px 32px rgba(0,0,0,.48);
    }
    .count{font-size:min(34vw, 12rem);font-weight:900;color:var(--turquoise)}

    /* Fin */
    .end{ text-align:center;padding:36px 24px }
    .thumb{font-size:min(24vw, 9rem)}
    .actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:16px}
    .btn{border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;border:1px solid transparent}
    .btn-primary{background:var(--turquoise);color:#071229}
    .btn-secondary{border-color:#ff5959;color:#ff5959;background:transparent}

    @media (max-width:700px){
      .grid-2{grid-template-columns:1fr}
      .shell{padding:24px 4%}
    }
  </style>
</head>
<body>

  <!-- ===== Header du site (mêmes classes que la home) ===== -->
  <header class="nav">
    <a href="index.html" class="brand">
      <img class="brand__logo" src="SMASH (6).png" alt="SMASH logo"/>
      <span class="brand__wordmark">SMASH</span>
    </a>
    <nav class="nav__links">
      <a href="shadow.html" class="nav-pill"><img src="Bolt.svg" class="nav-ic" alt="">Entraînement</a>
      <a href="guide.html"   class="nav-pill"><img src="Racket.svg" class="nav-ic" alt="">Matériel</a>
      <a href="partner.html" class="nav-pill"><img src="Partner.svg" class="nav-ic" alt="">Partenaires</a>
      <span class="nav-pill is-soon"><img src="Shop.svg" class="nav-ic" alt="">Boutique<span class="tooltip">Bientôt disponible</span></span>
    </nav>
    <button class="btn btn--ghost btn--disabled">
      <img src="Login.svg" class="nav-ic" alt="">Se connecter
      <span class="tooltip">Bientôt disponible</span>
    </button>
  </header>

  <main class="shell">
    <!-- ===== SETUP ===== -->
    <section id="setup" class="card">
      <h1 class="title">Shadow — Configuration</h1>
      <p class="muted">Paramètre ton exercice et lance‑toi.</p>

      <!-- Durée totale -->
      <div class="row">
        <label><strong>Durée totale :</strong> <span id="totalLabel" class="muted">1m 00s</span></label>
        <div class="slider-wrap">
          <input id="total" class="slider" type="range" min="30" max="180" step="5" value="60">
          <div class="ticks"><span>30s</span><span>1m 45s</span><span>3m</span></div>
        </div>
      </div>

      <!-- Intervalle -->
      <div class="row">
        <label><strong>Durée d'intervalle :</strong> <span id="intervalLabel" class="muted">5s</span></label>
        <div class="slider-wrap">
          <input id="interval" class="slider" type="range" min="2" max="8" step="0.5" value="5">
          <div class="ticks"><span>2s</span><span>5s</span><span>8s</span></div>
        </div>
      </div>

      <!-- Positions -->
      <div class="row">
        <label><strong>Positions à entraîner</strong></label>
        <div class="grid-2">
          <button class="dir-btn" data-dir="↖"><span class="arrow">↖</span><span class="lbl">Amorti Gauche</span></button>
          <button class="dir-btn" data-dir="↗"><span class="arrow">↗</span><span class="lbl">Amorti Droit</span></button>
          <button class="dir-btn" data-dir="←"><span class="arrow">←</span><span class="lbl">À Gauche</span></button>
          <button class="dir-btn" data-dir="→"><span class="arrow">→</span><span class="lbl">À Droite</span></button>
          <button class="dir-btn" data-dir="↙"><span class="arrow">↙</span><span class="lbl">Dégagement Gauche</span></button>
          <button class="dir-btn" data-dir="↘"><span class="arrow">↘</span><span class="lbl">Dégagement Droit</span></button>
        </div>
        <p id="dirWarn" class="warn">Sélectionne au moins une position pour commencer.</p>
      </div>

      <!-- Options -->
      <div class="row">
        <label class="opt"><input id="hideProgress" type="checkbox"> <span>Masquer la progression en cours</span></label>
      </div>

      <!-- GO -->
      <button id="go" class="go-btn" disabled><span>▶</span><span>GO !</span></button>
    </section>

    <!-- ===== RUN ===== -->
    <section id="run" style="display:none">
      <!-- Top bar : STOP toujours présent / temps masquable -->
      <div class="topbar">
        <button id="stopBtn" class="stop-btn">Arrêter</button>
        <div id="timeBox" class="time">
          <div class="big" id="timeLeft">0:00</div>
          <div class="small">Temps restant</div>
        </div>
      </div>

      <div id="arena" class="arena"></div>
    </section>
  </main>

  <script>
    // ===== Sélecteurs
    const $ = (id)=>document.getElementById(id);
    const setup = $('setup'), run = $('run'), arena = $('arena');
    const total = $('total'), interval = $('interval');
    const totalLabel = $('totalLabel'), intervalLabel = $('intervalLabel');
    const dirWarn = $('dirWarn'), hideProgress = $('hideProgress');
    const goBtn = $('go'), stopBtn = $('stopBtn'), timeBox = $('timeBox'), timeLeft = $('timeLeft');
    const dirButtons = Array.from(document.querySelectorAll('.dir-btn'));

    // ===== État
    let selected = new Set();
    let totalMs=0, intervalMs=0, remainingMs=0, intervalRemainingMs=0, tickId=null;
    let currentDir=null, hideUI=false;
    let wakeLock = null, wakeInterval = null;

    // Labels sliders
    const fmt = s => `${Math.floor(s/60)}m ${(s%60).toString().padStart(2,'0')}s`;
    totalLabel.textContent = fmt(+total.value);
    intervalLabel.textContent = `${(+interval.value).toFixed(1).replace('.0','')}s`;
    total.addEventListener('input',()=> totalLabel.textContent = fmt(+total.value));
    interval.addEventListener('input',()=> intervalLabel.textContent = `${(+interval.value).toFixed(1).replace('.0','')}s`);

    // Sélection positions
    dirButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        const d=b.dataset.dir;
        if(selected.has(d)){selected.delete(d);b.classList.remove('active');}
        else{selected.add(d);b.classList.add('active');}
        goBtn.disabled = selected.size===0;
        dirWarn.style.display = selected.size===0 ? 'block':'none';
      });
    });

    // Son
    function ding(){
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = 880; g.gain.setValueAtTime(0.35, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.12);
      o.start(); o.stop(ctx.currentTime + 0.12);
    }

    // Wake lock (anti veille)
    async function enableWakeLock(){
      try{
        if('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); }
        else{
          // Fallback : tick léger pour garder l’onglet "vivant"
          wakeInterval = setInterval(()=>{ window.scrollBy(0,0); }, 30000);
        }
      }catch(e){ /* ignore */ }
    }
    function disableWakeLock(){
      if(wakeLock){ wakeLock.release(); wakeLock=null; }
      if(wakeInterval){ clearInterval(wakeInterval); wakeInterval=null; }
    }

    function pick(){
      const arr = Array.from(selected);
      return arr[Math.floor(Math.random()*arr.length)];
    }
    function showArrow(d){ arena.innerHTML = `<div class="mega" aria-live="assertive">${d}</div>`; }
    function clearArena(){ arena.innerHTML = ``; }

    function updateTime(){
      const s = Math.max(0, Math.ceil(remainingMs/1000));
      timeLeft.textContent = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
      timeBox.style.visibility = hideUI ? 'hidden' : 'visible';
    }

    function tick(){
      const step=100;
      remainingMs-=step; intervalRemainingMs-=step;

      // cacher à 2/3
      if(currentDir && (intervalMs-intervalRemainingMs) >= intervalMs*(2/3)){
        currentDir=null; clearArena();
      }

      if(intervalRemainingMs<=0 && remainingMs>0){
        currentDir = pick(); showArrow(currentDir); intervalRemainingMs=intervalMs; ding();
      }
      if(remainingMs<=0){
        clearInterval(tickId); tickId=null; currentDir=null; clearArena();
        end();
        return;
      }
      updateTime();
    }

    function start(){
      totalMs = +total.value*1000;
      intervalMs = Math.round(+interval.value*1000);
      remainingMs=totalMs; intervalRemainingMs=intervalMs;
      hideUI = hideProgress.checked;

      setup.style.display='none'; run.style.display='';
      timeBox.style.visibility = hideUI ? 'hidden' : 'visible';
      enableWakeLock();

      // Countdown net (3,2,1,GO sans texte parasite)
      let c=3; arena.innerHTML=`<div class="count">${c}</div>`;
      const cd = setInterval(()=>{
        c--; if(c>0){ arena.innerHTML=`<div class="count">${c}</div>`; }
        else{
          clearInterval(cd);
          currentDir=pick(); showArrow(currentDir); ding(); updateTime();
          tickId=setInterval(tick,100);
        }
      },1000);
    }

    function end(){
      disableWakeLock();
      const box=document.createElement('div');
      box.className='end card';
      box.innerHTML = `
        <div class="thumb">👍</div>
        <h2 class="title" style="margin:10px 0 8px">Bien joué !</h2>
        <p class="muted" style="font-size:18px">Exercice terminé</p>
        <div class="actions">
          <button class="btn btn-primary" id="again">Recommencer</button>
          <button class="btn btn-secondary" id="cfg">Modifier les paramètres</button>
        </div>
      `;
      arena.appendChild(box);
      document.getElementById('again').onclick = start;
      document.getElementById('cfg').onclick = backToSetup;
    }

    function stop(){
      if(tickId){clearInterval(tickId);tickId=null;}
      disableWakeLock();
      backToSetup();
    }
    function backToSetup(){
      run.style.display='none'; setup.style.display=''; clearArena();
    }

    // Events
    goBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);

    // Affichages init
    goBtn.disabled = true;
  </script>
</body>
</html>
